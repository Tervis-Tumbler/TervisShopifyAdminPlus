<link rel="stylesheet" type="text/css" href="/static/css/compiled/catalyst/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/static/css/compiled/catalyst/bootstrap-responsive.css" />

<div id="content" class="container">
    <div id="debug" class="">
        <div>
            <button class="btn" type="button" id="btn-clearLog">Clear Log </button>
            <button class="btn" type="button" id="btn-showCart">Show Cart</button>
            <button class="btn" type="button" id="btn-showUser">Show User</button>
            <button class="btn" type="button" id="btn-showLocation">Show Location</button>
            <button class="btn" type="button" id="btn-test">Test</button>
        </div>
        <div>
            <pre><code id="debugArea">Debug:</code></pre>
        </div>
    </div>
</div>

<script>
    async function Get_TervisShopifyCart () {
        return new Promise((resolve, reject) => {
            ShopifyPOS.fetchCart({
                success: resolve,
                error: reject
            })
        })
    }

    // for metafield fetch 
    let $ShopifyProductMetafieldKey = '{{ globals.tervis.getShopifyProductMetafieldKey }}'
    let $ShopifyProductMetafieldURL = '{{ globals.tervis.getShopifyProductMetafieldURL }}'
    let $Domain = ("{{ shop.myshopify_domain }}").split(".")[0]
    let $ProductEBSDescriptonTable

    // everything else 
    let domain = ("{{ shop.myshopify_domain }}").split(".")[0]
    writeDebug(`Domain: ${domain}`)
    writeDebug("Shop Name: {{ shop.name }}")
    writeDebug("Shop Description: {{ shop.description }}")
    // Preload request
    let fetchPromise = fetch('{{ globals.tervis.itemFetchURL }}', {
            method: 'POST',
            headers: {
                'content-type': 'application/json',
                'x-functions-key':'{{ globals.tervis.authKey }}'
            },
            body: `{"domain":"${domain}"}`
        })
    let fetchResult

    function writeDebug(msg) {
        let debugWindow = document.getElementById("debugArea")
        debugWindow.innerText = `${debugWindow.innerText}\n${JSON.stringify(msg, null, 2)}`
    }

    function clearDebug() {
        let debugWindow = document.getElementById("debugArea")
        debugWindow.innerText = "Debug:"
    }

    function showCart() {
        try {
            ShopifyPOS.fetchCart({
                success: cart => writeDebug(cart),
                error: errors => ShopifyPOS.flashError("Failed to retrieve cart.")
            })
        } catch (err) {
            writeDebug(err)
        }
    }

    function showUser() {
        try {
            ShopifyPOS.fetchUser({
                success: user => writeDebug(user),
                error: errors => writeDebug(errors)
            })
        } catch (err) {
            writeDebug(err)
        }
    }

    function showLocation() {
        try {
            ShopifyPOS.fetchLocation({
                success: location => writeDebug(location),
                error: errors => writeDebug(errors)
            })
        } catch (err) {
            writeDebug(err)
        }
    }

    async function getCart() {
        return new Promise((resolve,reject) => 
            ShopifyPOS.fetchCart({
                success: resolve,
                error: reject
            })
        )
    }

    async function Get_ShopifyProductMetafield(
        {
            $ProductId,
            $Namespace,
            $Key
        }
    ) {
        let $Payload = JSON.stringify({
            domain: $Domain,
            productId: $ProductId,
            namespace: $Namespace,
            key: $Key
        })

        let $Options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-functions-key': $ShopifyProductMetafieldKey
            },
            body: $Payload
        }
        let $Response = await fetch($ShopifyProductMetafieldURL,$Options)
        return $Response.json()
    }

    async function New_ProductEBSDescriptionTable() {
        let $Cart = await Get_TervisShopifyCart()

        let $MetafieldPromises = $Cart.line_items.map(lineItem => {
            if (!lineItem.product_id) { return }
            return Get_ShopifyProductMetafield({
                $ProductId: lineItem.product_id,
                $Namespace: 'tervis',
                $Key: 'ebsDescription'
            })
        })

        let $Result = await Promise.all($MetafieldPromises)
        writeDebug("Product Table ready")
        return $Result.filter(element => element) // filters out nulls
    }

    function Get_EBSDescriptionFromProductId({
        $ProductId
    }) {
        writeDebug($ProductEBSDescriptonTable)
        writeDebug(`Finding ${$ProductId}`)
        let $Result = $ProductEBSDescriptonTable.find(entry => {
            return entry.productId == $ProductId
        })
        if ($Result === undefined) { return }
        return $Result.value
    }

    async function buttonTest() {
        writeDebug(Get_EBSDescriptionFromProductId({ $ProductId: '4777219621001'}))
        writeDebug("Button called")
    }

    function startButtons() {
        document.getElementById("btn-clearLog").addEventListener("click", () => clearDebug())
        document.getElementById("btn-showCart").addEventListener("click", showCart)
        document.getElementById("btn-showUser").addEventListener("click", showUser)
        document.getElementById("btn-showLocation").addEventListener("click", showLocation)
        document.getElementById("btn-test").addEventListener("click", buttonTest)
    }

    ShopifyPOS.ready(async () => {
        try {        
            //App view is now rendered
            $ProductEBSDescriptonTable = await New_ProductEBSDescriptionTable()
            writeDebug("Ready.")
            startButtons()
        } catch (err) {
            writeDebug(err)
            alert(err)
        }
    });
</script>
