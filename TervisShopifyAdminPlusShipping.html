<link rel="stylesheet" type="text/css" href="/static/css/compiled/catalyst/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/static/css/compiled/catalyst/bootstrap-responsive.css" />

<div id="content">
    <div id="customer">
        <h4>
            Ship To 
        </h4>
        <select name="Ship To" class="input-block-level" id="select-shipTo">
            <option disabled selected value="">Select "ship to" address</option>
        </select>
        <div id="customerInfo">None</div>
    </div>
    <div id="shipForm">
        <label for="select-shipMethod">
            <h4>
                Select ship method
            </h4>
        </label>
        <select name="Ship Methods" class="input-block-level" id="select-shipMethod"></select>
        <button type="button" class="btn btn-large btn-block btn-success" id="btn-submit" disabled>Submit</button>
        <button type="button" class="btn btn-large btn-block btn-danger hidden" id="btn-removeShipping">Remove shipping</button>
    </div>
    <div id="debug" class="">
        <div>
            <button class="btn" type="button" id="btn-clearLog">Clear Log </button>
            <button class="btn" type="button" id="btn-showCart">Show Cart</button>
            <button class="btn" type="button" id="btn-showShip">Show Ship Method Object</button>
            <button class="btn" type="button" id="btn-getSubtotal">Show Cart Subtotal</button>
            <button class="btn" type="button" id="btn-test">Test</button>
        </div>
        <div>
            <pre><code id="debugArea">Debug:</code></pre>
        </div>
    </div>
</div>
<script>
    let currentShipToAddress
    let cartCustomer
    let storeLocation
    let shipToSelect = document.getElementById("select-shipTo")
    let itemFetchPromise = getItemFetchPromise()
    let shippingItems
    let shipMethods = [
            {
                name: "None - Remove Shipping"
            },
            {
                name: "Other Store Pickup",
                value: "000001_FEDEX_P_GND",
                threshold: 0,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
            },
            {
                name: "Osprey Store Pickup",
                value: "000001_PICKUP_P_TRV",
                threshold: 0,
                freightTerms: "Paid",
                freightCarrierCode: "PICKUP"
            },
            {
                name: "Home Delivery - Regional",
                value: "000001_FEDEX_P_HDY",
                threshold: 49.99,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
                shippingSku: "Shipping-Standard"
            },
            {
                name: "Home Delivery - Extended",
                value: "000001_FEDEX_P_HDY",
                threshold: 49.99,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
                shippingSku: "Shipping-Extended"
            },
            {
                name: "Business Delivery - Regional",
                value: "000001_FEDEX_P_GND",
                threshold: 49.99,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
                shippingSku: "Shipping-Standard"
            },
            {
                name: "Business Delivery - Extended",
                value: "000001_FEDEX_P_GND",
                threshold: 49.99,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
                shippingSku: "Shipping-Extended"
            },
            {
                name: "Overnight Delivery",
                value: "000001_FEDEXP_A_SON",
                threshold: Number.MAX_SAFE_INTEGER,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
                shippingSku: "Shipping-Overnight"
            }
    ]

    function getItemFetchPromise() {
        let domain = ("{{ shop.myshopify_domain}}").split(".")[0]
        let url = '{{ globals.tervis.getTervisCustomItemsURL }}'
        let options = {
            method: 'POST',
            headers: {
                'content-type': 'application/json',
                'x-functions-key':'{{ globals.tervis.getTervisCustomItemsKey }}'
            },
            body: `{"domain":"${domain}"}`
        }
        return fetch(url, options)
    }

    async function resolveItemFetchPromise() {
        if (!shippingItems) {
            try {
                let response = await itemFetchPromise
                shippingItems = await response.json()
            } catch (error) {
                writeDebug(error)
                return
            }
        }
        return
    }

    async function getShippingItemVariantId(shipMethod) {
        await resolveItemFetchPromise()
        let shippingItem = shippingItems.find(item => {
            return item.title === shipMethod.shippingSku
        })
        return shippingItem.variantId
    }

    function writeDebug(msg) {
        let debugWindow = document.getElementById("debugArea")
        debugWindow.innerText = `${debugWindow.innerText}\n${JSON.stringify(msg, null, 2)}`
    }

    function clearDebug() {
        let debugWindow = document.getElementById("debugArea")
        debugWindow.innerText = "Debug:"
    }

    function showCart() {
        ShopifyPOS.fetchCart({
            success: cart => writeDebug(cart),
            error: errors => ShopifyPOS.flashError("Failed to retrieve cart")
        })
    }

    function showShipMethod() {
        writeDebug(getShipMethod())
    }

    function getShipMethod() {
        let selectedShipMethod = document.getElementById("select-shipMethod").value
        let result = shipMethods
            .filter(shipMethod => {
                return shipMethod.name === selectedShipMethod
            })[0]
        return result
    }

    function getAddressFromDropdown() {
        index = parseInt(shipToSelect.value)
        if (index === Number.MAX_SAFE_INTEGER) {
            storeLocation.name = `${cartCustomer.first_name} ${cartCustomer.last_name}`
            storeLocation.first_name = cartCustomer.first_name
            storeLocation.last_name = cartCustomer.last_name
            storeLocation.province_code = storeLocation.province
            return storeLocation
        } else if (index === NaN) {
            Shopify.flashError("Select an address")
        } else{
            return cartCustomer.addresses[index]
        }
    }

    function updateCurrentShipToAddress() {
        currentShipToAddress = getAddressFromDropdown()
        showCustomerInformation()
    }

    function addShipMethodsToDropdown() {
        let dropdown = document.getElementById("select-shipMethod")
        shipMethods.forEach(method => {
            let option = document.createElement("option")
            option.text = method.name
            dropdown.add(option)
        })
    }

    function addShipToOptionsToDropdown() {
        let dropdown = document.getElementById("select-shipTo")
        if (cartCustomer.addresses !== undefined) {
            cartCustomer.addresses.forEach((a, index) => {
                let option = document.createElement("option")
                option.text = `${a.address1} ${a.address2}, ${a.city}, ${a.province_code} ${a.zip}`
                option.value = index
                dropdown.add(option)
            })
        }
        try {
            let option = document.createElement("option")
            option.text = storeLocation.name
            option.value = Number.MAX_SAFE_INTEGER
            dropdown.add(option)
        } catch(e) {
            alert(e)
            writeDebug(e)
        }
    }

    function enableSubmitButton(bool) {
        document.getElementById("btn-submit").disabled = !bool
    }

    function getIndexOfShippingItemInCart(cart) {
        let index = cart.line_items.findIndex(item => {
            return item.title === "Shipping"
        })
        return index
    }

    function showCustomerInformation() {
        try {
            let customerInfo = `${currentShipToAddress.name}
                ${currentShipToAddress.address1} ${currentShipToAddress.address2 ? `\n${currentShipToAddress.address2}` : ""}
                ${currentShipToAddress.city}, ${currentShipToAddress.province_code} ${currentShipToAddress.zip}
            `
            document.getElementById("customerInfo").innerText = customerInfo
        } catch (e) {alert(e);writeDebug(e)}
    }

    function testIsOverFreeShippingThreshold(cart, shipMethod) {
        return shipMethod.threshold ? cart.subtotal > shipMethod.threshold : true
    }

    async function submitShippingLineItem() {
        let shipMethod = getShipMethod()
        let freeFreight = ""
        if (
            shipMethod.name !== "None - Remove Shipping" &&
            shipToSelect.value === ""
        ) {
            ShopifyPOS.flashError("Please select a Ship To location")
        }
        else {
            try {
                await removeShipping()
                if (shipMethod.name === "None - Remove Shipping") {
                    ShopifyPOS.flashNotice(`Shipping removed.`)
                    ShopifyPOS.Modal.close()
                } else {
                    ShopifyPOS.fetchCart({
                        success: async cart => {
                            let isOverFreeShippingThreshold = testIsOverFreeShippingThreshold(cart, shipMethod)
                            if (!isOverFreeShippingThreshold) {
                                cart.addLineItem({
                                    variantId: await getShippingItemVariantId(shipMethod),
                                    quantity: 1
                                }, {
                                    success: {},
                                    error: errors => ShopifyPOS.flashError(errors)
                                })
                            } else {
                                freeFreight = "Y"
                            }
                            cart.addProperties({
                                // ship method
                                shipMethod: shipMethod.name,
                                shipMethodCode: shipMethod.value,
                                freightTerms: shipMethod.freightTerms,
                                freeFreight: freeFreight,
                                // customer information
                                customerFirstName: currentShipToAddress.first_name,
                                customerLastName: currentShipToAddress.last_name,
                                customerAddress1: currentShipToAddress.address1,
                                customerAddress2: currentShipToAddress.address2,
                                customerCity: currentShipToAddress.city,
                                customerState: currentShipToAddress.province_code,
                                customerZip: currentShipToAddress.zip,
                                customerCountryCode: currentShipToAddress.country_code
                            }, {
                                success: () => {
                                    ShopifyPOS.flashNotice(`${shipMethod.name} shipping added.`)
                                    ShopifyPOS.Modal.close()
                                },
                                error: errors => ShopifyPOS.flashError(errors)
                            })
                            writeDebug(cart)
                        },
                        error: () => ShopifyPOS.flashError("Error adding shipping.")
                    })
                }
            } catch {
                ShopifyPOS.flashError("Error sumbitting changes.")
            }
        }
    }

    function removeShipping() {
        return new Promise((resolve,reject) => {
            ShopifyPOS.fetchCart({
                success: cart => {
                    cart.removeProperties(["shipMethod", "shipMethodCode", "freightTerms", "freeFreight","customerFirstName","customerLastName","customerAddress1","customerAddress2","customerCity","customerState","customerZip","customerCountryCode"], {
                        success: cart => {
                            let shippingItemIndex = getIndexOfShippingItemInCart(cart)
                            if (shippingItemIndex !== -1) {
                                cart.removeLineItem(shippingItemIndex, {
                                    success: () => {
                                        enableSubmitButton(true)
                                    },
                                    error: e => {
                                        ShopifyPOS.flashError("Error removing shipping line item")
                                        reject(e)
                                    }
                                })
                            }
                            resolve()
                        },
                        error: e => {
                            ShopifyPOS.flashError("Error removing shipping")
                            reject(e)
                        }
                    })
                },
                error: e => {
                    ShopifyPOS.flashError("Error fetching cart")
                    reject(e)
                }
            })
        })
    }

    function startForm() {
        ShopifyPOS.fetchCart({
            success: cart => {
                cartCustomer = cart.customer
                writeDebug(cartCustomer)
                if (cartCustomer !== undefined) {
                    try {
                        addShipToOptionsToDropdown()
                        enableSubmitButton(true)
                    } catch (e) {
                        alert(e)
                        writeDebug(e)
                    }
                } else {
                    ShopifyPOS.flashError("Please set a customer first.")
                }
            },
            error: errors => ShopifyPOS.flashError(errors)
        })
        ShopifyPOS.fetchLocation({
            success: location => storeLocation = location,
            error: errors => ShopifyPOS.flashError(errors)
        })
        addShipMethodsToDropdown()
    }

    function buttonTest() {
        writeDebug(shipToSelect.value)
    }

    function addEventListeners() {
        shipToSelect.addEventListener("change", updateCurrentShipToAddress)
        document.getElementById("btn-submit").addEventListener("click", submitShippingLineItem)
        document.getElementById("btn-clearLog").addEventListener("click", clearDebug)
        document.getElementById("btn-showCart").addEventListener("click", showCart)
        document.getElementById("btn-showShip").addEventListener("click", showShipMethod)
        document.getElementById("btn-removeShipping").addEventListener("click", removeShipping)
        document.getElementById("btn-test").addEventListener("click", buttonTest)
    }

    ShopifyPOS.ready(() => {
        try {
            //App view is now rendered
            writeDebug("Ready.")
            addEventListeners()
            startForm()
        } catch (err) {
            writeDebug(err)
            alert(err)
        }
    });
</script>
