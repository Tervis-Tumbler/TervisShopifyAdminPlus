<link rel="stylesheet" type="text/css" href="/static/css/compiled/catalyst/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/static/css/compiled/catalyst/bootstrap-responsive.css" />

<div id="content">
    <div id="customer">
        <h4>
            Customer 
        </h4>
        <div id="customerInfo"></div>
    </div>
    <div id="shipForm">
        <label for="select-shipMethod">
            <h4>
                Select ship method
            </h4>
        </label>
        <select name="Ship Methods" class="input-block-level" id="select-shipMethod"></select>
        <button type="button" class="btn btn-large btn-block btn-success" id="btn-submit" disabled>Submit</button>
        <button type="button" class="btn btn-large btn-block btn-danger hidden" id="btn-removeShipping">Remove shipping</button>
    </div>
    <div id="debug" class="hidden">
        <div>
            <button class="btn" type="button" id="btn-clearLog">Clear Log </button>
            <button class="btn" type="button" id="btn-showCart">Show Cart</button>
            <button class="btn" type="button" id="btn-showShip">Show Ship Method Object</button>
            <button class="btn" type="button" id="btn-getSubtotal">Show Cart Subtotal</button>
            <button class="btn" type="button" id="btn-test">Test</button>
        </div>
        <div>
            <pre><code id="debugArea">Debug:</code></pre>
        </div>
    </div>
</div>
<script>
    let shipMethods = [
            {
                name: "None"
            },
            {
                name: "Other Store Pickup",
                value: "000001_FEDEX_P_GND",
                threshold: 0,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
            },
            {
                name: "Osprey Store Pickup",
                value: "000001_PICKUP_P_TRV",
                threshold: 0,
                freightTerms: "Paid",
                freightCarrierCode: "PICKUP"
            },
            {
                name: "Home Delivery - Regional",
                value: "000001_FEDEX_P_HDY",
                threshold: 49.99,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
                variantId: 31865728565329
            },
            {
                name: "Home Delivery - Extended",
                value: "000001_FEDEX_P_HDY",
                threshold: 49.99,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
                variantId: 31895877910609
            },
            {
                name: "Business Delivery - Regional",
                value: "000001_FEDEX_P_GND",
                threshold: 49.99,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
                variantId: 31865728565329
            },
            {
                name: "Business Delivery - Extended",
                value: "000001_FEDEX_P_GND",
                threshold: 49.99,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
                variantId: 31895877910609
            },
            {
                name: "Overnight Delivery",
                value: "000001_FEDEXP_A_SON",
                threshold: Number.MAX_SAFE_INTEGER,
                freightTerms: "Freight Collect",
                freightCarrierCode: "FEDEX",
                variantId: 31865728598097
            }
    ]

    function writeDebug(msg) {
        let debugWindow = document.getElementById("debugArea")
        debugWindow.innerText = `${debugWindow.innerText}\n${JSON.stringify(msg, null, 2)}`
    }

    function clearDebug() {
        let debugWindow = document.getElementById("debugArea")
        debugWindow.innerText = "Debug:"
    }

    let clearButton = document.getElementById("btn-clearLog")
    clearButton.addEventListener("click", () => clearDebug())

    function showCart() {
        ShopifyPOS.fetchCart({
            success: cart => writeDebug(cart),
            error: errors => ShopifyPOS.flashError("Failed to retrieve cart")
        })
    }

    function showShipMethod() {
        writeDebug(getShipMethod())
    }

    function getShipMethod() {
        let selectedShipMethod = document.getElementById("select-shipMethod").value
        let result = shipMethods
            .filter(shipMethod => {
                return shipMethod.name === selectedShipMethod
            })[0]
        return result
    }

    function addShipMethodsToDropdown() {
        let dropdown = document.getElementById("select-shipMethod")
        shipMethods.forEach(method => {
            let option = document.createElement("option")
            option.text = method.name
            dropdown.add(option)
        })
    }

    function enableSubmitButton(bool) {
        document.getElementById("btn-submit").disabled = !bool
    }

    function getIndexOfShippingItemInCart(cart) {
        let index = cart.line_items.findIndex(item => {
            return item.title === "Shipping"
        })
        return index
    }

    function showCustomerInformation(customer) {
        let addr = customer.addresses[0]
        let customerInfo = `${addr.name}
            ${addr.address1} ${addr.address2 ? `\n${addr.address2}` : ""}
            ${addr.city}, ${addr.province_code} ${addr.zip}
        `
        document.getElementById("customerInfo").innerText = customerInfo
    }

    function testIsOverFreeShippingThreshold(cart, shipMethod) {
        return shipMethod.threshold ? cart.subtotal > shipMethod.threshold : true
    }

    function submitShippingLineItem() {
        let shipMethod = getShipMethod()
        let freeFreight = ""
        if (shipMethod.name === "None") {
            removeShipping()
            ShopifyPOS.flashNotice(`Shipping removed.`)
            ShopifyPOS.Modal.close()
        } else {
            ShopifyPOS.fetchCart({
                success: cart => {
                    let isOverFreeShippingThreshold = testIsOverFreeShippingThreshold(cart, shipMethod)
                    // let shipFee = isOverFreeShippingThreshold ? "0" : shipMethod.price.toString()
                    if (!isOverFreeShippingThreshold) {
                        cart.addLineItem({
                            variantId: shipMethod.variantId,
                            quantity: 1
                        }, {
                            success: {},
                            error: errors => ShopifyPOS.flashError(errors)
                        })
                    } else {
                        // freeFreight = shipMethod.freightTerms === "Freight Collect" ? "Y" : ""
                        freeFreight = "Y"
                    }
                    cart.addProperties({
                        shipMethod: shipMethod.name,
                        shipMethodCode: shipMethod.value,
                        // shipFee: shipFee,
                        freightTerms: shipMethod.freightTerms,
                        freeFreight: freeFreight
                    }, {
                        success: () => {
                            ShopifyPOS.flashNotice(`${shipMethod.name} shipping added.`)
                            ShopifyPOS.Modal.close()
                        },
                        error: errors => ShopifyPOS.flashError(errors)
                    })
                    writeDebug(cart)
                },
                error: () => ShopifyPOS.flashError("Error adding shipping.")
            })
        }
    }

    function removeShipping() {
        ShopifyPOS.fetchCart({
            success: cart => {
                cart.removeProperties(["shipMethod", "shipMethodCode", "freightTerms", "freeFreight"], {
                    success: cart => {
                        let shippingItemIndex = getIndexOfShippingItemInCart(cart)
                        if (shippingItemIndex !== -1) {
                            cart.removeLineItem(shippingItemIndex, {
                                success: () => enableSubmitButton(true),
                                error: () => ShopifyPOS.flashError("Error removing shipping line item")
                            })
                        }
                    },
                    error: () => ShopifyPOS.flashError("Error removing shipping")
                })
            },
            error: () => ShopifyPOS.flashError("Error fetching cart")
        })
    }

    function startForm() {
        ShopifyPOS.fetchCart({
            success: cart => {
                let shippingItemIndex = getIndexOfShippingItemInCart(cart)
                // if (cart.customer && shippingItemIndex === -1) {
                if (cart.customer) {
                    showCustomerInformation(cart.customer)
                    enableSubmitButton(true)
                }
                else if (!cart.customer) {
                    ShopifyPOS.flashError("Please set a customer first.")
                }
                // else if (shippingItemIndex !== -1) {
                //     ShopifyPOS.flashError("There is already a Shipping item in cart. Please remove it to add a new one.")
                // }
            },
            error: errors => writeDebug(errors)
        })
        addShipMethodsToDropdown()
    }

    function buttonTest() {
        ShopifyPOS.fetchCart({
            success: cart => {
                cart.addLineItemProperties(0, {
                    someProp: "Here it is"
                }, {
                    success: ShopifyPOS.flashNotice("yay"),
                    error: errors => ShopifyPOS.flashError(errors)
                })
            },
            error: errors => ShopifyPOS.flashError(errors)
        })
    }

    function startButtons() {
        document.getElementById("btn-showCart").addEventListener("click", showCart)
        document.getElementById("btn-showShip").addEventListener("click", showShipMethod)
        document.getElementById("btn-submit").addEventListener("click", submitShippingLineItem)
        document.getElementById("btn-removeShipping").addEventListener("click", removeShipping)
        document.getElementById("btn-test").addEventListener("click", buttonTest)
    }

    ShopifyPOS.ready(() => {
        try {
            //App view is now rendered
            writeDebug("Ready.")
            startButtons()
            startForm()
        } catch (err) {
            writeDebug(err)
            alert(err)
        }
    });
</script>
