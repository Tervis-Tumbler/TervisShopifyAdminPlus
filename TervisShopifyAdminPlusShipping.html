<div id="content">
    <div id="customer">
        Customer: <div id="customerInfo"></div>
    </div>
    <div id="shipForm">
        <label for="select-shipMethod">Ship method: </label>
        <select name="Ship Methods" id="select-shipMethod"></select>
        <button type="button" id="btn-submit" disabled>Submit</button>
        <button type="button" id="btn-removeShipping">Remove shipping</button>
    </div>
    <div id="debug" style="display: none;">
        <div class="btn">
            <button type="button" id="btn-clearLog">Clear Log </button>
            <button type="button" id="btn-showCart">Show Cart</button>
            <button type="button" id="btn-showShip">Show Ship Method Object</button>
            <button type="button" id="btn-getSubtotal">Show Cart Subtotal</button>
            <button type="button" id="btn-test">Test</button>
        </div>
        <div>
            <pre><code id="debugArea">Debug:</code></pre>
        </div>
    </div>
</div>
<script>
    let shipMethods = [
        {
            name: "Made For Life/Osprey Pickup",
            value: "000001_CUSTROUTE_L_TBD",
            price: 0,
            threshold: 0
        },
        {
            name: "FedEx Air Standard Overnight",
            value: "000001_FEDEXP_A_SON",
            price: 20,
            threshold: Number.MAX_SAFE_INTEGER,
            variantId: 31865728598097
        },
        {
            name: "FedEx Parcel Ground (Business)",
            value: "000001_FEDEX_P_GND",
            price: 6.95,
            threshold: 49.99,
            variantId: 31865728565329
        },
        {
            name: "FedEx Parcel Home Delivery (Residential)",
            value: "000001_FEDEX_P_HDY",
            price: 6.95,
            threshold: 49.99,
            variantId: 31865728565329
        },
        {
            name: "Pick up in store",
            value: "000001_PICKUP_P_TRV",
            price: 0,
            threshold: 0
        }
    ]

    function writeDebug(msg) {
        let debugWindow = document.getElementById("debugArea")
        debugWindow.innerText = `${debugWindow.innerText}\n${JSON.stringify(msg, null, 2)}`
    }

    function clearDebug() {
        let debugWindow = document.getElementById("debugArea")
        debugWindow.innerText = "Debug:"
    }

    let clearButton = document.getElementById("btn-clearLog")
    clearButton.addEventListener("click", () => clearDebug())

    function showCart() {
        ShopifyPOS.fetchCart({
            success: cart => writeDebug(cart),
            error: errors => ShopifyPOS.flashError("Failed to retrieve cart")
        })
    }

    function showShipMethod() {
        writeDebug(getShipMethod())
    }

    function getShipMethod() {
        let selectedShipMethod = document.getElementById("select-shipMethod").value
        let result = shipMethods
            .filter(shipMethod => {
                return shipMethod.name === selectedShipMethod
            })[0]
        return result
    }

    function addShipMethodsToDropdown() {
        let dropdown = document.getElementById("select-shipMethod")
        shipMethods.forEach(method => {
            let option = document.createElement("option")
            option.text = method.name
            dropdown.add(option)
        })
    }

    function enableSubmitButton(bool) {
        document.getElementById("btn-submit").disabled = !bool
    }

    function getIndexOfShippingItemInCart(cart) {
        let index = cart.line_items.findIndex(item => {
            return item.title === "Shipping"
        })
        return index
    }

    function showCustomerInformation(customer) {
        let addr = customer.addresses[0]
        let customerInfo = `${addr.name}
            ${addr.address1} ${addr.address2 ? `\n${addr.address2}` : ""}
            ${addr.city}, ${addr.province_code} ${addr.zip}
        `
        document.getElementById("customerInfo").innerText = customerInfo
    }

    function testIsOverFreeShippingThreshold(cart, shipMethod) {
        return shipMethod.threshold ? cart.subtotal > shipMethod.threshold : true
    }

    function submitShippingLineItem() {
        let shipMethod = getShipMethod()
        ShopifyPOS.fetchCart({
            success: cart => {
                let isOverFreeShippingThreshold = testIsOverFreeShippingThreshold(cart, shipMethod)
                let shipFee = isOverFreeShippingThreshold ? "0" : shipMethod.price.toString()
                if (!isOverFreeShippingThreshold) {
                    cart.addLineItem({
                        variantId: shipMethod.variantId,
                        quantity: 1
                    }, {
                        success: {},
                        error: errors => ShopifyPOS.flashError(errors)
                    })
                }
                cart.addProperties({
                    shipMethod: shipMethod.name,
                    shipMethodCode: shipMethod.value,
                    shipFee: shipFee
                }, {
                    success: () => {
                        ShopifyPOS.flashNotice(`${shipMethod.name} shipping added.`)
                        ShopifyPOS.Modal.close()
                    },
                    error: errors => ShopifyPOS.flashError(errors)
                })
                writeDebug(cart)
            },
            error: () => ShopifyPOS.flashError("Error adding shipping.")
        })
    }

    function removeShipping() {
        ShopifyPOS.fetchCart({
            success: cart => {
                cart.removeProperties(["shipFee", "shipMethod", "shipMethodCode"], {
                    success: cart => {
                        let shippingItemIndex = getIndexOfShippingItemInCart(cart)
                        if (shippingItemIndex !== -1) {
                            cart.removeLineItem(shippingItemIndex, {
                                success: () => enableSubmitButton(true),
                                error: () => ShopifyPOS.flashError("Error removing shipping line item")
                            })
                        }
                    },
                    error: () => ShopifyPOS.flashError("Error removing shipping")
                })
            },
            error: () => ShopifyPOS.flashError("Error fetching cart")
        })
    }

    function startForm() {
        ShopifyPOS.fetchCart({
            success: cart => {
                let shippingItemIndex = getIndexOfShippingItemInCart(cart)
                if (cart.customer && shippingItemIndex === -1) {
                    showCustomerInformation(cart.customer)
                    enableSubmitButton(true)
                }
                else if (!cart.customer) {
                    ShopifyPOS.flashError("Please set a customer first.")
                }
                else if (shippingItemIndex !== -1) {
                    ShopifyPOS.flashError("There is already a Shipping item in cart. Please remove it to add a new one.")
                }
            },
            error: errors => writeDebug(errors)
        })
        addShipMethodsToDropdown()
    }

    function buttonTest() {
        ShopifyPOS.fetchCart({
            success: cart => {
                cart.addLineItemProperties(0, {
                    someProp: "Here it is"
                }, {
                    success: ShopifyPOS.flashNotice("yay"),
                    error: errors => ShopifyPOS.flashError(errors)
                })
            },
            error: errors => ShopifyPOS.flashError(errors)
        })
    }

    function startButtons() {
        document.getElementById("btn-showCart").addEventListener("click", showCart)
        document.getElementById("btn-showShip").addEventListener("click", showShipMethod)
        document.getElementById("btn-submit").addEventListener("click", submitShippingLineItem)
        document.getElementById("btn-removeShipping").addEventListener("click", removeShipping)
        document.getElementById("btn-test").addEventListener("click", buttonTest)
    }

    ShopifyPOS.ready(() => {
        try {
            //App view is now rendered
            writeDebug("Ready.")
            startButtons()
            startForm()
        } catch (err) {
            writeDebug(err)
            alert(err)
        }
    });
</script>
